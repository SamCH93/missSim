---
title: "Handling Missingness and Non-Convergence in Simulation Studies"
subtitle: "Literature Review Analysis"
author: 
 - Samuel Pawel
 - Björn S. Siepe
 - Anna Lohmann
 - František Bartoš
date: "20 August 2024"
format:
  html:
    toc: true
    number-sections: true
    theme: cosmo
    code-fold: true
    code-tools: true
    code-summary: "Show the code"
    fig-width: 7
    fig-height: 4.5
    fig-align: "center"
execute:
  message: false
  warning: false
---

# Background
This document contains code to analyze the results of the literature review on missingness in simulation studies. 


TODOS:

- ensure that "yes" is always the darker shaded one where I use alpha




# Prep
Load all relevant packages and the data: 
```{r}
set.seed(2024)
library(tidyverse)
library(here)
library(sysfonts)
library(readxl)

# Load data
# TODO adapt to full data, only with my own data for now
data_lr <- readxl::read_xlsx(here("data/lit_review_data_BS.xlsx"))

# Remove entries for coding interrater agreement
# TODO
# temporary
data_lr <- data_lr |> 
  filter(!is.na(doi)) |> 
  filter(journal != "EM") |> 
  rename(q1_is_sim_study = Q1_Is_sim_stufy) |> 
  janitor::clean_names()
```




Set some global theme options for plotting:
```{r}
# Taken from Okabeito
cols <- c("SiM" = "#0072B2", "PM" = "#E69F00", "RSM" = "#009E73", "JASA" = "#F0E442")
# cols <- c("BRM" = "#E69F00", "MBR" = "#56B4E9", "PM" = "#009E73")

# Alternative font
theme_bs <- function(){
  # add google font
  sysfonts::font_add_google("News Cycle", "news")
  # use showtext
  showtext::showtext_auto()
  
  # theme
  ggplot2::theme_minimal(base_family = "news") +
    ggplot2::theme(
      # remove minor grid
      panel.grid.minor = ggplot2::element_blank(),
      # Title and Axis Texts
      plot.title = ggplot2::element_text(face = "plain",
                                         size = ggplot2::rel(1.2),
                                         hjust = 0.5),
      plot.subtitle = ggplot2::element_text(size = ggplot2::rel(1.1),
                                            hjust = 0.5),
      axis.text.x = ggplot2::element_text(face = "plain", size = 15),
      axis.title.x = ggplot2::element_text(face = "plain", size = 18),
      axis.title.y = ggplot2::element_text(face = "plain", size = 18),
      axis.line = element_line(colour = "#6d6d6e"),
      
      # Faceting
      strip.text = ggplot2::element_text(face = "plain",
                                         size = ggplot2::rel(1.1),
                                         hjust = 0.5),
      strip.text.x.top = ggplot2::element_text(face = "plain", 
                                               size = ggplot2::rel(1.2),
                                               hjust = 0.5),
      # strip.text.y = element_blank(),
      strip.background = ggplot2::element_rect(fill = NA, color = NA),
      # Grid
      panel.grid = ggplot2::element_line(colour = "#F3F4F5"),
      # Legend
      legend.title = ggplot2::element_text(face = "plain"),
      legend.position = "top",
      legend.justification = 1,
      # Panel/Facets
      panel.spacing.x = ggplot2::unit(1.6, "lines"),
      panel.spacing.y = ggplot2::unit(1.6, "lines"),
      # Remove vertical grid lines
      panel.grid.major.x = ggplot2::element_blank(),
      text = element_text(size = 22)
      
    )
}

theme_set(theme_bs())
```



# Visualizations of Individual Questions

## Q0/Q1: Proportion of Sim Studies per Journal/Year/Reviewer

The following plot shows the number of simulation studies per journal.
```{r}
q1_plot_max <- data_lr |> 
  count(journal) |> 
  pull(n) |> 
  max() * 1.1

data_lr |> 
  ggplot(aes(x = journal, fill = journal, alpha = q1_is_sim_study)) +
    geom_bar(col = 1) +
    labs(x = NULL, 
         title ="Number of simulation studies per journal", 
         fill = "Journal") +
    # scale_fill_discrete_qualitative(palette = pal) + 
    scale_fill_manual(values = cols) +
    scale_alpha_manual(values = c(0.33, 1), guide = "none") +
    scale_y_continuous(limits = c(0, q1_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank(),
          legend.position = "none")+
    labs(y = NULL)
```

The following plot shows the proportion of simulation studies per year.
```{r}
peryear_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  count(year) |> 
  pull(n) |> 
  max() * 1.1

data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  ggplot(aes(x = year, fill = journal)) +
    geom_bar(col = 1) +
    labs(x = NULL, 
         title ="Number of simulation studies per year", 
         fill = "Journal") +
    scale_fill_manual(values = cols) +
    theme(panel.grid.major.x = element_blank())+
    scale_y_continuous(limits = c(0, peryear_plot_max), expand = c(0,0))+
    scale_x_continuous(breaks = seq(2018, 2023, 1))+
    labs(y = NULL)
```


The following plot shows the proportion of simulation studies per reviewer.
```{r}
reviewer_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  count(reviewer) |>
  pull(n) |>
  max() * 1.1

data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  ggplot(aes(x = reviewer, fill = journal)) +
    geom_bar(col = 1) +
    labs(x = NULL, 
         title ="Number of simulation studies per reviewer", 
         fill = "Journal") +
    scale_fill_manual(values = cols) +
    theme(panel.grid.major.x = element_blank())+
    scale_y_continuous(limits = c(0, reviewer_plot_max), expand = c(0,0))+
    labs(y = NULL)
```


## Q2: Mention of Missingness

The following plot shows the ratio of simulation studies mentioning some form of missingness.
```{r}
# obtain max for y-axis
q2_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "no") |> 
  count() |> 
  pull(n) * 1.1

data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  ggplot(aes(x = q2_mentions_missingness, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Mentions missingness", y = "Number of studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    theme(panel.grid.major.x = element_blank())+
    scale_y_continuous(limits = c(0, q2_plot_max), expand = c(0,0))
```


Or proportional per journal:
```{r}
data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  ggplot(aes(alpha = q2_mentions_missingness, 
             x = journal, 
             fill = journal))+
    geom_bar(position = "fill", col = 1)+
    labs(x = "Mentions missingness", 
         y = "Proportion of studies", 
         fill = "Journal",
         alpha = "")+
    scale_y_continuous(labels = scales::percent_format(),
                       limits = c(0,1), expand = c(0,0))+
    scale_alpha_manual(values = c(0.33, 1), guide = "none")+
    scale_fill_manual(values = cols)+
    theme(panel.grid.major.x = element_blank(),
          legend.position = "none")
```



### Q2a: Place of Missingness Mention

If missingness was mentioned, where was it reported?

```{r}
q2a_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  group_by(journal) |>
  count() |> 
  pull(n) |> 
  max() * 1.1

data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  pivot_longer(cols = all_of(contains("mentions_missingness_")), 
               names_to = "place_of_missingness", 
               values_to = "value") |> 
  mutate(place_of_missingness = str_remove(place_of_missingness, "mentions_missingness_")) |> 
  filter(value == TRUE) |> 
  group_by(journal, place_of_missingness) |> 
  summarise(place_count = n()) |> 
  # nicer naming
  mutate(place_of_missingness = case_match(place_of_missingness,
    "q2b_data_generation" ~ "Data Generation",
    "q2c_results" ~ "Results",
    "q2a_discussion" ~ "Discussion",
  )) |> 
  ggplot(aes(x = place_of_missingness, y = place_count, fill = journal, group = journal))+
  geom_bar(stat = "identity", 
           position = position_dodge2(preserve = "single"), 
           col = 1) +
  labs(x = "Place of Missingness Mention", y = "Number of Studies", fill = "Journal")+
  scale_fill_manual(values = cols)+
  scale_y_continuous(limits = c(0, q2a_plot_max), expand = c(0,0))+
  theme(panel.grid.major.x = element_blank())
```



### Q2.1: Missingness Reporting
How is missingness reported?

```{r}

```


### Q2.2: Missigness Summary

How are the missing cases summarized?

## Q3: Handling of Missingness

The following plot shows, conditional on mentioning missingness, how authors reported how they handled missingness.

```{r}
q3_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  group_by(q3_report_dealing_with_missingness) |>
  count() |> 
  pull(n) * 1.1

data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  ggplot(aes(x = q3_report_dealing_with_missingness, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Indicated how missingness was handled", y = "Number of Studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q3_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())
```


### Q3.1: Method of Handling Missingness

If authors report how they dealt with missingness, what method did they use?

```{r}
q31_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  filter(q3_report_dealing_with_missingness == "yes") |> 
  group_by(q3_1_method_dealing_with_missingness) |>
  count() |> 
  pull(n) |> 
  max() * 1.1

data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  filter(q2_mentions_missingness == "yes") |>
  filter(q3_report_dealing_with_missingness == "yes") |>
  ggplot(aes(x = q3_1_method_dealing_with_missingness, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Method of handling missingness", y = "Number of studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q31_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())
```


### Q3.2: Missingness Handling Justification

If authors report how they dealt with missingness, what justification did they provide for their choice?

```{r}
q32_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  filter(q3_report_dealing_with_missingness == "yes") |> 
  group_by(q3_2_method_justification) |>
  count() |> 
  pull(n) |> 
  max() * 1.1

data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  filter(q2_mentions_missingness == "yes") |>
  filter(q3_report_dealing_with_missingness == "yes") |>
  ggplot(aes(x = q3_2_method_justification, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Missingness Handling Justified", y = "Number of Studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q32_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())
```


#### Q 3.3. Type of Justification

If authors provide a justification for their choice of handling missingness, what type of justification do they provide?
```{r}
q33_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  filter(q3_report_dealing_with_missingness == "yes") |> 
  group_by(q3_3_type_justification) |>
  count() |> 
  pull(n) |> 
  max() * 1.1

data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  filter(q2_mentions_missingness == "yes") |>
  filter(q3_report_dealing_with_missingness == "yes") |>
  filter(q3_2_method_justification == "yes") |>
  ggplot(aes(x = q3_3_type_justification, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Type of Justification", y = "Number of Studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q33_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())
```


## Q4: Code Availability

If the study was a simulation study, was code available?
```{r}
q4_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  group_by(q4_code_available) |>
  count() |> 
  pull(n) |> 
  max() * 1.1

data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  ggplot(aes(x = q4_code_available, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Code availability", y = "Number of studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q4_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())
```

The same, but per journal:
```{r}
data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(!is.na(q4_code_available)) |>
  ggplot(aes(alpha = q4_code_available, x = journal, fill = journal))+
    geom_bar(col = 1, position = "fill")+
  theme(legend.position = "none") + 
   scale_alpha_manual(values = c(0.33, 1), guide = "none") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0,1), expand = c(0,0)) +
    labs(x = "Journal", y = "Proportion of Studies with Code", fill = "Journal")+
    scale_fill_manual(values = cols)
```

# Combined Plots for Manuscript


# Descriptives
Create one large table with descriptive stats:

```{r}
data_lr |> 
  select(journal, q1_is_sim_study, q2_mentions_missingness, q3_report_dealing_with_missingness, q4_code_available) |> 
  mutate(across(-journal, as.factor)) |> 
  pivot_longer(cols = -journal, names_to = "question", values_to = "answer") |> 
  group_by(journal, question) |> 
  count(answer) |> 
  pivot_wider(names_from = answer, values_from = n) |> 
  select(question, journal, everything()) |> 
  arrange(question) |> 
  mutate(question = case_when(
    question == "q1_is_sim_study" ~ "Q1: Is a simulation study?",
    question == "q2_mentions_missingness" ~ "Q2: Mention missingness?",
    question == "q3_report_dealing_with_missingness" ~ "Q3: Reports dealing with missingness?",
    question == "q4_code_available" ~ "Q4: Code available?"
  )) |>
  knitr::kable()
```




# Session Info
```{r}
pander::pander(sessionInfo())
```
