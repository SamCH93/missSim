---
title: "Handling Missingness and Non-Convergence in Simulation Studies"
subtitle: "Literature Review Analysis"
author: 
 - Samuel Pawel
 - Björn S. Siepe
 - Anna Lohmann
 - František Bartoš
date: "20 August 2024"
format:
  html:
    toc: true
    number-sections: true
    theme: cosmo
    code-fold: true
    code-tools: true
    code-summary: "Show the code"
    fig-width: 7
    fig-height: 4.5
    fig-align: "center"
    embed-resources: true
execute:
  message: false
  warning: false
---

# Background
This document contains code to analyze the results of the literature review on missingness in simulation studies.


# Prep
Load all relevant packages and the data: 
```{r}
set.seed(2024)
library(tidyverse)
library(here)
library(sysfonts)
library(readxl)
library(cowplot)
library(scales)
library(ggpubr)

# Load data
data_lr <- readxl::read_xlsx(here("data/sim_res.xlsx"))

# Remove entries for coding interrater agreement
data_lr <- data_lr |> 
  filter(id != "agreement" | is.na(id))

# change "other deletion" to "other" for clarity
data_lr <- data_lr |> 
  mutate(q3_1_method_dealing_with_missingness = ifelse(q3_1_method_dealing_with_missingness == "other deletion", "other", q3_1_method_dealing_with_missingness))
```




Set some global theme options for plotting:
```{r}
# Taken from Okabeito
cols <- c("SiM" = "#0072B2", "PM" = "#E69F00", "RSM" = "#009E73", "JASA" = "#F0E442")
# cols <- c("BRM" = "#E69F00", "MBR" = "#56B4E9", "PM" = "#009E73")

# Alternative font
theme_bs <- function(){
  # add google font
  sysfonts::font_add_google("News Cycle", "news")
  # use showtext
  showtext::showtext_auto()
  
  # theme
  ggplot2::theme_minimal(base_family = "news") +
    ggplot2::theme(
      # remove minor grid
      panel.grid.minor = ggplot2::element_blank(),
      # Title and Axis Texts
      plot.title = ggplot2::element_text(face = "plain",
                                         size = ggplot2::rel(1.2),
                                         hjust = 0.5),
      plot.subtitle = ggplot2::element_text(size = ggplot2::rel(1.1),
                                            hjust = 0.5),
      axis.text.x = ggplot2::element_text(face = "plain", size = 24),
      axis.title.x = ggplot2::element_text(face = "plain", size = 24),
      axis.title.y = ggplot2::element_text(face = "plain", size = 24),
      axis.line = element_line(colour = "#6d6d6e"),
      
      # Faceting
      strip.text = ggplot2::element_text(face = "plain",
                                         size = ggplot2::rel(1.1),
                                         hjust = 0.5),
      strip.text.x.top = ggplot2::element_text(face = "plain", 
                                               size = ggplot2::rel(1.2),
                                               hjust = 0.5),
      # strip.text.y = element_blank(),
      strip.background = ggplot2::element_rect(fill = NA, color = NA),
      # Grid
      panel.grid = ggplot2::element_line(colour = "#F3F4F5"),
      # Legend
      legend.title = ggplot2::element_text(face = "plain"),
      legend.position = "top",
      legend.justification = 1,
      # Panel/Facets
      panel.spacing.x = ggplot2::unit(1.6, "lines"),
      panel.spacing.y = ggplot2::unit(1.6, "lines"),
      # Remove vertical grid lines
      panel.grid.major.x = ggplot2::element_blank(),
      text = ggplot2::element_text(size = 33)
      
    )
}

theme_set(theme_bs())
```



# Visualizations of Individual Questions

## Q0/Q1: Proportion of Sim Studies per Journal/Year/Reviewer

The following plot shows the number of simulation studies per journal (in the darker area) as a proportion of all studies per journal (combined with the non-sim studies in the lighter area).
```{r}
q1_plot_max <- data_lr |> 
  count(journal) |> 
  pull(n) |> 
  max() * 1.1

q1_plot <- data_lr |> 
  filter(q1_is_sim_study != "unclear") |> 
  ggplot(aes(x = journal, fill = journal, alpha = q1_is_sim_study)) +
    geom_bar(col = 1) +
    labs(x = NULL, 
         title ="Number of simulation studies per journal", 
         fill = "Journal") +
    # scale_fill_discrete_qualitative(palette = pal) + 
    scale_fill_manual(values = cols) +
    scale_alpha_manual(values = c(0.25, 1), guide = "none") +
    scale_y_continuous(limits = c(0, q1_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank(),
          legend.position = "none")+
    labs(y = NULL)
q1_plot
```

The following plot shows the proportion of simulation studies per year.
```{r}
peryear_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  count(year) |> 
  pull(n) |> 
  max() * 1.1

q1_plot_year <- data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  ggplot(aes(x = year, fill = journal)) +
    geom_bar(col = 1) +
    labs(x = NULL, 
         title ="Number of simulation studies per year", 
         fill = "Journal") +
    scale_fill_manual(values = cols) +
    theme(panel.grid.major.x = element_blank())+
    scale_y_continuous(limits = c(0, peryear_plot_max), expand = c(0,0))+
    scale_x_continuous(breaks = seq(2018, 2023, 1))+
    labs(y = NULL)

q1_plot_year
```


The following plot shows the proportion of simulation studies per reviewer.
```{r}
reviewer_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  count(reviewer) |>
  pull(n) |>
  max() * 1.1

q1_plot_rev <- data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  ggplot(aes(x = reviewer, fill = journal)) +
    geom_bar(col = 1) +
    labs(x = NULL, 
         title ="Number of simulation studies per reviewer", 
         fill = "Journal") +
    scale_fill_manual(values = cols) +
    theme(panel.grid.major.x = element_blank())+
    scale_y_continuous(limits = c(0, reviewer_plot_max), expand = c(0,0))+
    labs(y = NULL)
q1_plot_rev
```


## Q2: Mention of Missingness

The following plot shows the ratio of simulation studies mentioning some form of missingness.
```{r}
# obtain max for y-axis
q2_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "no") |> 
  count() |> 
  pull(n) * 1.1

q2_plot <- data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  ggplot(aes(x = q2_mentions_missingness, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Mentions missingness", y = "Number of studies", fill = "Journal:")+
    scale_fill_manual(values = cols)+
    theme(panel.grid.major.x = element_blank())+
    scale_y_continuous(limits = c(0, q2_plot_max), expand = c(0,0))
q2_plot
```


Or proportional per journal: 
```{r}
# obtain raw numbers of "yes" mentions per journal
q2_plot_prop_numbers <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  # divide number of "yes" mentions by total number of studies per journal
  count(journal, q2_mentions_missingness) |>
  group_by(journal) |>
  mutate(pos = n/sum(n)) |>
  filter(q2_mentions_missingness == "yes") |> 
  # hard code positioning
  mutate(pos = ifelse(journal == "JASA", pos+0.035, pos)) |> 
  mutate(pos = ifelse(journal == "SiM", pos+0.03, pos))


q2_plot_prop <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  ggplot(aes(alpha = q2_mentions_missingness, 
             x = journal, 
             fill = journal))+
    geom_bar(position = "fill", col = 1)+
    labs(x = "Mentions missingness", 
         y = "Proportion of studies", 
         fill = "Journal",
         alpha = "")+
    scale_y_continuous(labels = scales::percent_format(),
                       breaks = seq(0, 1, 0.1),
                       limits = c(0,1), expand = c(0,0))+
    scale_alpha_manual(values = c(0.25, 1), guide = "none")+
    scale_fill_manual(values = cols)+
    theme(panel.grid.major.x = element_blank(),
          legend.position = "none")+
    # add text labels with raw numbers 
    geom_text(data = q2_plot_prop_numbers, 
              aes(label = n, 
                  y = pos,), 
                position = position_stack(vjust = 1.09),  # Adjust vjust to move the labels above the lower bar
              size = 10)

q2_plot_prop
```



### Q2a: Place of Missingness Mention

If missingness was mentioned, where was it reported?

```{r}
q2a_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  group_by(journal) |>
  count() |> 
  pull(n) |> 
  max() * 1.1

q2a_plot <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  pivot_longer(cols = all_of(contains("mentions_missingness_")), 
               names_to = "place_of_missingness", 
               values_to = "value") |> 
  mutate(place_of_missingness = str_remove(place_of_missingness, "mentions_missingness_")) |> 
  filter(value == TRUE) |> 
  group_by(journal, place_of_missingness) |> 
  summarise(place_count = n()) |> 
  # nicer naming
  mutate(place_of_missingness = case_match(place_of_missingness,
    "q2b_data_generation" ~ "Data Generation",
    "q2c_results" ~ "Results",
    "q2a_discussion" ~ "Discussion",
  )) |> 
  ggplot(aes(x = place_of_missingness, y = place_count, fill = journal, group = journal))+
  geom_bar(stat = "identity", 
           position = position_dodge2(preserve = "single"), 
           col = 1) +
  labs(x = "Place of Missingness Mention", y = "Number of Studies", fill = "Journal")+
  scale_fill_manual(values = cols)+
  scale_y_continuous(limits = c(0, q2a_plot_max), expand = c(0,0))
q2a_plot
```



### Q2.1: Missingness Reporting
How is missingness reported if it is mentioned? This excludes the additional 'other' comment for now.

```{r}
q2_1_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  group_by(journal) |>
  count() |> 
  pull(n) |> 
  max() * 1.1


q2_1_plot <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  select(journal, q2_1a_missingness_sumarized_text,
         q2_1b_missingness_sumarized_table, q2_1c_missingness_sumarized_visualization) |> 
  pivot_longer(cols = -journal, 
               names_to = "missingness_reporting", 
               values_to = "value") |> 
  filter(value == TRUE) |> 
  group_by(journal, missingness_reporting) |>
  summarise(reporting_count = n()) |>
  mutate(missingness_reporting = case_match(missingness_reporting,
    "q2_1a_missingness_sumarized_text" ~ "Text",
    "q2_1b_missingness_sumarized_table" ~ "Table",
    "q2_1c_missingness_sumarized_visualization" ~ "Visualization",
  )) |>
  ggplot(aes(x = missingness_reporting, y = reporting_count, fill = journal, group = journal))+
  geom_bar(stat = "identity", 
           position = position_dodge2(preserve = "single"), 
           col = 1) +
  labs(x = "Missingness Reporting", y = "Number of Studies", fill = "Journal")+
  scale_fill_manual(values = cols)+
  scale_y_continuous(limits = c(0, q2_1_plot_max), expand = c(0,0))+
  theme_bs()
q2_1_plot
```




### Q2.2: Missigness Summary

How are the missing cases summarized? 'Prop.' stands for proportion, so 'prop. (method/condition)' would be the missingness proportion per method and condition.

```{r}
q2_2_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  count(q2_2_missingness_summarized) |> 
  pull(n) |> 
  max() * 1.1


q2_2_plot <- data_lr |>
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
    mutate(q2_2_missingness_summarized = case_match(q2_2_missingness_summarized,
       "missing proportion (total)" ~ "prop.",
       "missing proportion (per method/condition)" ~ "prop. (method/condition)",
       "max missing proportion (per method/condition)" ~ "max prop. (method/condition)",
       "missing proportion (per method)" ~ "prop. (method)",
       "max missing proportion (per method)" ~ "max prop. (method)",
       "zero missingness" ~ "no missingness",
       .default = q2_2_missingness_summarized
    
  )) |> 
  mutate(q2_2_missingness_summarized = fct_infreq(q2_2_missingness_summarized)) |> 
  ggplot(aes(x = q2_2_missingness_summarized, fill = journal, group = journal))+
  geom_bar(col = 1)+
  labs(x = "Missingness Summary", y = "Number of Studies", fill = "Journal")+
  scale_fill_manual(values = cols)+
  scale_y_continuous(limits = c(0, q2_2_plot_max), expand = c(0,0))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

q2_2_plot
```



## Q3: Handling of Missingness

The following plot shows, conditional on mentioning missingness, how authors reported how they handled missingness.

```{r}
q3_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  group_by(q3_report_dealing_with_missingness) |>
  count() |> 
  pull(n) * 1.1

q3_plot <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  ggplot(aes(x = q3_report_dealing_with_missingness, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Indicated how missingness was handled", y = "Number of Studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q3_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())
q3_plot
```

Or, alternatively, with an own category for "missingness not mentioned":
```{r}
q3_nonmention_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "no") |> 
  count() |> 
  pull(n) |> 
  max() * 1.1


# calculate raw numbers
q3_nonmention_counts <- data_lr |>
  filter(q1_is_sim_study == "yes") |> 
  mutate(q3_report_dealing_with_missingness = if_else(q2_mentions_missingness == "no", 
                                                      "not mentioned", 
                                                      q3_report_dealing_with_missingness)) |> 
  count(q3_report_dealing_with_missingness)


q3_plot_nonmention <- data_lr |>
  filter(q1_is_sim_study == "yes") |> 
  mutate(q3_report_dealing_with_missingness = if_else(q2_mentions_missingness == "no", 
                                                      "not mentioned", 
                                                      q3_report_dealing_with_missingness)) |>
  mutate(q3_report_dealing_with_missingness = factor(q3_report_dealing_with_missingness, 
                                                     levels = c("not mentioned", 
                                                                "no", 
                                                                "unclear", 
                                                                "yes"))) |>  
  ggplot(aes(x = q3_report_dealing_with_missingness, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Indicated how missingness was handled", y = "Number of Studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q3_nonmention_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())+
    # add raw numbers
    geom_text(data = q3_nonmention_counts, 
              aes(x = q3_report_dealing_with_missingness, y = n, label = n), 
              vjust = -0.5, size = 10, inherit.aes = FALSE)

q3_plot_nonmention
```



### Q3.1: Method of Handling Missingness

If authors report how they dealt with missingness, what method did they use?

```{r}
q31_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  # filter(q3_report_dealing_with_missingness == "yes") |> 
  group_by(q3_1_method_dealing_with_missingness) |>
  count() |> 
  pull(n) |> 
  max() * 1.1

q3_1_plot <- data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  filter(q2_mentions_missingness == "yes") |>
  filter(q3_report_dealing_with_missingness == "yes" | q3_report_dealing_with_missingness == "unclear") |>
  # change NA to "other" -> was missingness as outcome
  mutate(q3_1_method_dealing_with_missingness = if_else(is.na(q3_1_method_dealing_with_missingness), 
                                                        "other", 
                                                        q3_1_method_dealing_with_missingness)) |>
  mutate(q3_1_method_dealing_with_missingness = case_match(q3_1_method_dealing_with_missingness,
                                                           "additional simulations" ~ "add sims",
                                                           "method replacement" ~ "replace method",
                                                           .default = q3_1_method_dealing_with_missingness)) |> 
  
  # order q3_1 by frequency
  mutate(q3_1_method_dealing_with_missingness = fct_infreq(q3_1_method_dealing_with_missingness)) |>
  ggplot(aes(x = q3_1_method_dealing_with_missingness, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Method of handling missingness", y = "Number of studies", fill = "Journal")+
    scale_x_discrete(labels = scales::label_wrap(10))+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q31_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())
          # axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
q3_1_plot
```


### Q3.2: Missingness Handling Justification

If authors report how they dealt with missingness, what justification did they provide for their choice?

```{r}
q32_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  filter(q3_report_dealing_with_missingness == "yes") |> 
  group_by(q3_2_method_justification) |>
  count() |> 
  pull(n) |> 
  max() * 1.1

q3_2_plot <- data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  filter(q2_mentions_missingness == "yes") |>
  filter(q3_report_dealing_with_missingness == "yes") |>
  ggplot(aes(x = q3_2_method_justification, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Missingness Handling Justified", y = "Number of Studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q32_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())
q3_2_plot
```


#### Q 3.3. Type of Justification

If authors provide a justification for their choice of handling missingness, what type of justification do they provide?
```{r}
q33_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  filter(q3_report_dealing_with_missingness == "yes" | q3_report_dealing_with_missingness == "unclear") |> 
  group_by(q3_3_type_justification) |>
  count() |> 
  pull(n) |> 
  max() * 1.1

q3_3_plot <- data_lr |> 
  filter(q1_is_sim_study == "yes") |>
  filter(q2_mentions_missingness == "yes") |>
  filter(q3_report_dealing_with_missingness == "yes" | q3_report_dealing_with_missingness == "unclear") |>
  filter(q3_2_method_justification == "yes") |>
  ggplot(aes(x = q3_3_type_justification, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Type of Justification", y = "Number of Studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q33_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())

q3_3_plot
```


## Q4: Code Availability

If the study was a simulation study, was code available?
```{r}
q4_plot_max <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  group_by(q4_code_available) |>
  count() |> 
  pull(n) |> 
  max() * 1.1

q4_plot <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  ggplot(aes(x = q4_code_available, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Code availability", y = "Number of studies", fill = "Journal")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q4_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank())
q4_plot
```

The same, but per journal:
```{r}
# compute raw numbers and proportions
q4_counts <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(!is.na(q4_code_available)) |>
  group_by(journal, q4_code_available) |>
  count() |> 
  group_by(journal) |> 
  mutate(prop = n/sum(n))



q4_plot_prop <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(!is.na(q4_code_available)) |>
  ggplot(aes(alpha = q4_code_available, x = journal, fill = journal))+
    geom_bar(col = 1, position = "fill")+
  theme(legend.position = "none") + 
   scale_alpha_manual(values = c(0.25, 1), guide = "none") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0,1), expand = c(0,0)) +
    labs(x = "Journal", y = "Proportion of Studies with Code", fill = "Journal")+
    scale_fill_manual(values = cols) +
   geom_text(data = q4_counts, 
             aes(x = journal,
                 y = prop, 
                 group = q4_code_available,
                 label = n), 
             position = position_stack(vjust = 0.5), 
             size = 10,
             inherit.aes = FALSE)
q4_plot_prop
```

# Combined Plots for Manuscript

## Tweak existing plots
First, slightly tweak the plots for the combined figure:
```{r}
# obtain counts for plotting
q2_plot_counts <- data_lr |>
  filter(q1_is_sim_study == "yes") |>
  count(q2_mentions_missingness) |>
  mutate(prop = n/sum(n))


q2_plot_max_pub <- q2_plot_max * 1.05
q2_plot_pub <- data_lr |>
  filter(q1_is_sim_study == "yes") |>
  ggplot(aes(x = q2_mentions_missingness, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Mentions missingness", y = "Number of studies", fill = "Journal:")+
    scale_fill_manual(values = cols)+
    theme(panel.grid.major.x = element_blank())+
    scale_y_continuous(limits = c(0, q2_plot_max_pub), expand = c(0, 0.2))+
    geom_text(data = q2_plot_counts,
              aes(x = q2_mentions_missingness,
                  y = n,
                  label = n),
              vjust = -0.5,
              size = 5.8,
              inherit.aes = FALSE)+
   theme(legend.position = "none",
                                  text = element_text(size = 18),
                                  axis.text.x = element_text(size = 18),
         axis.text.y = element_text(size = 18),
                                  axis.title.y = element_text(size = 16))+
                            labs(x = NULL,
                                 y = NULL,
                                 title = "Missingness mentioned?")

q1_plot_max <- data_lr |> 
  count(journal) |> 
  pull(n) |> 
  max() * 1.1

# get some counts
q1_plot_counts <- data_lr |> 
  count(journal, q1_is_sim_study) |> 
  filter(q1_is_sim_study == "yes") |> 
  group_by(journal) |> 
  mutate(prop = n/sum(n))

q1_plot_pub <- data_lr |> 
  filter(q1_is_sim_study != "unclear") |> 
  ggplot(aes(x = journal, fill = journal, alpha = q1_is_sim_study)) +
    geom_bar(col = 1) +
    labs(x = NULL, 
         title ="Number of simulation studies per journal", 
         fill = "Journal") +
    # add raw numbers
    geom_text(data = q1_plot_counts, 
              aes(x = journal, y = n, label = n, group = q1_is_sim_study), 
              size = 5.8, inherit.aes = FALSE, position = position_stack(vjust = 0.5)) + 
                             theme(legend.position = "none",
                                  text = element_text(size = 18),
                                  axis.text.x = element_text(size = 18),
                                  axis.text.y = element_text(size = 18),
                                  axis.title.y = element_text(size = 16))+
    # scale_fill_discrete_qualitative(palette = pal) + 
    scale_fill_manual(values = cols) +
    scale_alpha_manual(values = c(0.25, 1), guide = "none") +
    scale_y_continuous(limits = c(0, q1_plot_max), expand = c(0,0))+
    theme(panel.grid.major.x = element_blank(),
          legend.position = "none",
          text = element_text(size = 18))+
    labs(y = NULL)




q3_nonmention_plot_max_pub <- q3_nonmention_plot_max * 1.1
q3_plot_nonmention_pub <- data_lr |>
  filter(q1_is_sim_study == "yes") |> 
  mutate(q3_report_dealing_with_missingness = if_else(q2_mentions_missingness == "no", 
                                                      "not mentioned", 
                                                      q3_report_dealing_with_missingness)) |>
  mutate(q3_report_dealing_with_missingness = factor(q3_report_dealing_with_missingness, 
                                                     levels = c("not mentioned", 
                                                                "no", 
                                                                "unclear", 
                                                                "yes"))) |>  
  ggplot(aes(x = q3_report_dealing_with_missingness, fill = journal, group = journal))+
    geom_bar(col = 1)+
    labs(x = "Indicated how missingness was handled", y = "Number of Studies", fill = "Journal:")+
    scale_fill_manual(values = cols)+
    scale_y_continuous(limits = c(0, q3_nonmention_plot_max_pub), expand = c(0, 0.2))+
    # add raw numbers
    geom_text(data = q3_nonmention_counts, 
              aes(x = q3_report_dealing_with_missingness, y = n, label = n), 
              vjust = -0.5, size = 5.8, inherit.aes = FALSE) + 
                             theme(legend.position = "none",
                                  text = element_text(size = 18),
                                  axis.text.x = element_text(size = 18),
                                  axis.text.y = element_text(size = 18),
                                  axis.title.y = element_text(size = 16))+
                             labs(x = NULL,
                                  y = NULL,
                                  title = "Missingness handling reported?")+
  ggpubr::geom_bracket(xmin = 1.75, xmax = 4.25, 
               inherit.aes = FALSE, label = "If mentioned",
               y.position = 130, label.size = 5.8)


# obtain counts for plotting
q3_1_plot_counts <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(q2_mentions_missingness == "yes") |> 
  filter(q3_report_dealing_with_missingness == "yes" | q3_report_dealing_with_missingness == "unclear") |> 
    mutate(
    q3_1_method_dealing_with_missingness = if_else(
      is.na(q3_1_method_dealing_with_missingness),
      "other",
      q3_1_method_dealing_with_missingness
    )
  ) |>
  mutate(
    q3_1_method_dealing_with_missingness = case_match(
      q3_1_method_dealing_with_missingness,
      "additional simulations" ~ "add sims",
      "method replacement" ~ "replace",
      "case-wise deletion" ~ "case- wise",
      "list-wise deletion" ~ "list- wise",
      .default = q3_1_method_dealing_with_missingness
    )
  ) |>
  count(q3_1_method_dealing_with_missingness) |>
  mutate(prop = n/sum(n))

q31_plot_max_pub <- q31_plot_max * 1.05
q3_1_plot_pub <- data_lr |>
  filter(q1_is_sim_study == "yes") |>
  filter(q2_mentions_missingness == "yes") |>
  filter(q3_report_dealing_with_missingness == "yes" | q3_report_dealing_with_missingness == "unclear") |>
  # change NA to "outcome"
  mutate(
    q3_1_method_dealing_with_missingness = if_else(
      is.na(q3_1_method_dealing_with_missingness),
      "other",
      q3_1_method_dealing_with_missingness
    )
  ) |>
  mutate(
    q3_1_method_dealing_with_missingness = case_match(
      q3_1_method_dealing_with_missingness,
      "additional simulations" ~ "add sims",
      "method replacement" ~ "replace",
      "case-wise deletion" ~ "case- wise",
      "list-wise deletion" ~ "list- wise",
      .default = q3_1_method_dealing_with_missingness
    )
  ) |> 
  # order q3_1 by frequency
  mutate(q3_1_method_dealing_with_missingness = fct_infreq(q3_1_method_dealing_with_missingness)) |>
  ggplot(aes(x = q3_1_method_dealing_with_missingness, fill = journal, group = journal)) +
  geom_bar(col = 1) +
  geom_text(data = q3_1_plot_counts, 
            aes(x = q3_1_method_dealing_with_missingness, 
                y = n, 
                label = n), 
            vjust = -0.5, 
            size = 5.8, 
            inherit.aes = FALSE) +
  labs(x = "Method of handling missingness", y = "Number of studies", fill = "Journal:") +
  scale_x_discrete(labels = scales::label_wrap(4)) +
  scale_fill_manual(values = cols) +
  scale_y_continuous(limits = c(0, q31_plot_max_pub), expand = c(0, 0.2)) +
  theme(legend.position = "none",
                                  text = element_text(size = 18),
                                  axis.text.x = element_text(size = 18),
                                  axis.text.y = element_text(size = 18))+
                             labs(x = NULL,
                                  y = NULL,
                                  title = "Method of handling missingness reported?")



q4_plot_prop_pub <- data_lr |> 
  filter(q1_is_sim_study == "yes") |> 
  filter(!is.na(q4_code_available)) |>
  ggplot(aes(alpha = q4_code_available, x = journal, fill = journal))+
    geom_bar(col = 1, position = "fill")+
  theme(legend.position = "none") + 
   scale_alpha_manual(values = c(0.25, 1), guide = "none") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0,1), expand = c(0,0)) +
    labs(x = "Journal", y = "Proportion of Studies with Code", fill = "Journal:")+
    scale_fill_manual(values = cols) +
   geom_text(data = q4_counts, 
             aes(x = journal,
                 y = prop, 
                 group = q4_code_available,
                 label = n), 
             position = position_stack(vjust = 0.5), 
             size = 5.8,
             inherit.aes = FALSE)+
    theme(legend.position = "none",
          text = element_text(size = 18),
                                  axis.text.x = element_text(size = 18),
                                  axis.text.y = element_text(size = 18),
          axis.title.y = element_text(size = 16))+
    labs(x = NULL,
         y = NULL,
         title = "Code for simulation study available?")+
  theme(panel.background = element_rect(colour = "#F3F4F5"))
```


## Combine into one plot
Combine plots for Q2 (Mention of Missingness per Journal), Q3 (Handling of Missingness per Journal) Q3.1 (Method of Handling Missingness per Journal), Q4 (Code availability):
```{r}
# create a shared legend
leg_plot <- q2_plot +
  theme(legend.text = element_text(size = 17),
        legend.title = element_text(size = 17),
        legend.spacing.x = unit(4, 'in'),
        legend.key.spacing.x = unit(0.25, 'in'))

legend <- cowplot::get_plot_component(leg_plot, 'guide-box-top', return_all = TRUE)



# combine plots
# only use one legend for all plots
p_c <- cowplot::plot_grid(q1_plot_pub, 
                          q3_plot_nonmention_pub, 
                           q3_1_plot_pub,
                           q4_plot_prop_pub,
                   nrow = 2, labels = c("A", "B", "C", "D"), label_size = 18,
                   align = "h",
                   scale = 0.95)

p_c_leg <- cowplot::plot_grid(legend,
                              p_c, 
                              nrow = 2, 
                              ncol = 1, 
                              rel_widths = 
                                c(0.3, 1),
                              rel_heights = c(0.05, 1))

p_c_leg


```

Save plots:
```{r, eval = FALSE}
ggsave("literature-review/figures/fig_lit_review_results.pdf", p_c_leg, width = 15*0.76, height = 10*0.76)
```

 

# Descriptives
Create one large table with descriptive stats:

```{r}
data_lr |> 
  select(journal, q1_is_sim_study, q2_mentions_missingness, q3_report_dealing_with_missingness, q4_code_available) |> 
  mutate(across(-journal, as.factor)) |> 
  pivot_longer(cols = -journal, names_to = "question", values_to = "answer") |> 
  group_by(journal, question) |> 
  count(answer) |> 
  pivot_wider(names_from = answer, values_from = n) |> 
  select(question, journal, everything()) |> 
  arrange(question) |> 
  mutate(question = case_when(
    question == "q1_is_sim_study" ~ "Q1: Is a simulation study?",
    question == "q2_mentions_missingness" ~ "Q2: Mention missingness?",
    question == "q3_report_dealing_with_missingness" ~ "Q3: Reports dealing with missingness?",
    question == "q4_code_available" ~ "Q4: Code available?"
  )) |>
  knitr::kable()
```




# Session Info
```{r}
pander::pander(sessionInfo())
```
